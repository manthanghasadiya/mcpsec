"""
State tracking for the interactive MCP exploitation session.
"""

from dataclasses import dataclass, field
from datetime import datetime
from typing import Any, Optional
from mcpsec.models import Finding

@dataclass
class AttemptRecord:
    """Records a single payload attempt during an exploitation session."""
    timestamp: datetime
    tool: str
    payload: dict[str, Any]
    response: Any
    latency_ms: float
    notes: str = ""
    success: bool = False

@dataclass
class ExploitState:
    """Maintains the state of an exploitation sequence against a specific finding or target."""
    finding: Optional[Finding] = None           # Original scan finding (if launched from a scan)
    target: str = ""                            # Target server connection string
    stage: str = "boundary_testing"             # e.g., "boundary_testing", "confirmation", "escalation", "impact_demo"
    attempts: list[AttemptRecord] = field(default_factory=list) # Every payload tried + response
    confirmed: bool = False                     # Whether the vulnerability is confirmed
    severity_evidence: list[str] = field(default_factory=list)  # Evidence supporting severity rating
    server_behavior: dict[str, Any] = field(default_factory=dict) # Learned traits: e.g., "strips ../", "url-decodes"
    ai_context: str = ""                        # Running summary for AI prompt context
    
    def add_attempt(self, tool: str, payload: dict[str, Any], response: Any, latency_ms: float, success: bool = False, notes: str = ""):
        """Records a new attempt in the exploit state."""
        self.attempts.append(
            AttemptRecord(
                timestamp=datetime.now(),
                tool=tool,
                payload=payload,
                response=response,
                latency_ms=latency_ms,
                notes=notes,
                success=success,
            )
        )
