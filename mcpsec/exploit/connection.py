"""
Persistent MCP connection handling for exploit sessions.
"""

from typing import Optional, Tuple
from mcpsec.client.mcp_client import MCPSecClient
from mcpsec.models import ServerProfile, TransportType

async def establish_connection(target: str, transport: TransportType, headers: Optional[dict] = None) -> Tuple[MCPSecClient, ServerProfile]:
    """
    Establishes a persistent connection to an MCP server.
    
    The caller is responsible for eventually calling `await client.close()` 
    when the session terminates.
    """
    client = MCPSecClient()
    try:
        if transport == TransportType.STDIO:
            profile = await client.connect_stdio(target)
        else:
            profile = await client.connect_http(target, headers=headers)
        return client, profile
    except Exception as e:
        await client.close()
        raise e
