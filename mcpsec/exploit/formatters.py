"""
Rich console formatting specifically for the REPL environment.
"""

from rich.console import Console
from rich.table import Table
from rich.panel import Panel
from rich.syntax import Syntax
from rich import box
import json

from ..models import ServerProfile, ToolInfo

repl_console = Console()

def print_repl_banner(target: str, transport: str, num_tools: int):
    """Prints the welcome banner for the exploit session."""
    repl_console.print(f"\n[bold green]mcpsec exploit[/bold green] â€” Interactive MCP Exploitation Session")
    repl_console.print(f"Target: [cyan]{target}[/cyan]")
    repl_console.print(f"Transport: [muted]{transport}[/muted] | Protocol: 2024-11-05")
    repl_console.print(f"\nğŸ“‹ [accent]Server Capabilities:[/accent]")
    repl_console.print(f"  Tools ({num_tools})")
    repl_console.print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")

def print_help():
    """Prints REPL help commands."""
    table = Table(box=box.MINIMAL, show_header=False, padding=(0,2))
    table.add_column("Command", style="cyan bold")
    table.add_column("Description", style="white")
    
    cmds = [
        ("help", "Show all commands"),
        ("tools", "List available MCP tools"),
        ("call <tool> <args>", "Call a tool. Example: call read_file {'path':'/etc'}"),
        ("test <finding>", "Start AI-guided exploitation of a finding (e.g. test 1)"),
        ("findings", "Show loaded findings"),
        ("history", "Show session attempt history"),
        ("status", "Show current exploitation status"),
        ("poc", "Generate a PoC for a confirmed vulnerability"),
        ("clear", "Clear screen"),
        ("exit/quit", "End session")
    ]
    for cmd, desc in cmds:
        table.add_row(cmd, desc)
    repl_console.print(Panel(table, title="[bold]Available Commands[/bold]", expand=False, border_style="dim"))

def print_tool_list(profile: ServerProfile):
    """Prints tools available in the server."""
    for t in profile.tools:
        args_str = ", ".join([f"{k}: {v}" for k, v in t.parameters.items()])
        repl_console.print(f"  [cyan]{t.name}[/cyan] [dim]({args_str})[/dim]")
        repl_console.print(f"    {t.description}")
        
def print_json_response(data: dict):
    """Pretty prints a JSON response."""
    formatted = json.dumps(data, indent=2)
    syntax = Syntax(formatted, "json", theme="monokai", word_wrap=True)
    repl_console.print(syntax)
