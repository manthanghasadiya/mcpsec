rules:
  # ═══════════════════════════════════════════════════════════════
  # PYTHON BROAD PATTERNS — Common vulnerabilities in Python MCP servers
  # ═══════════════════════════════════════════════════════════════

  # --- open() with non-literal path ---
  - id: broad-python-open-non-literal
    patterns:
      - pattern: open($PATH, ...)
      - pattern-not: open("...", ...)
      - pattern-not: open('...', ...)
    languages: [python]
    severity: WARNING
    message: >
      open() with non-literal path. If the path comes from user input,
      this allows reading/writing arbitrary files. Use pathlib and
      validate with resolve() + is_relative_to().
    metadata:
      cwe: CWE-22
      category: path-traversal
      confidence: MEDIUM

  # --- Path operations with variables ---
  - id: broad-python-pathlib-user-input
    patterns:
      - pattern-either:
          - pattern: Path($X).read_text(...)
          - pattern: Path($X).read_bytes()
          - pattern: Path($X).write_text(...)
          - pattern: Path($X).write_bytes(...)
          - pattern: Path($X).open(...)
          - pattern: Path($X).unlink(...)
      - pattern-not: Path("...").read_text(...)
      - pattern-not: Path("...").write_text(...)
    languages: [python]
    severity: WARNING
    message: >
      Pathlib operation with variable path. Validate the resolved path
      stays within the intended directory.
    metadata:
      cwe: CWE-22
      category: path-traversal
      confidence: MEDIUM

  # --- os.path.join doesn't prevent traversal ---
  - id: broad-python-os-path-join
    patterns:
      - pattern: os.path.join($BASE, $INPUT)
      - pattern-not: os.path.join("...", "...")
    languages: [python]
    severity: INFO
    message: >
      os.path.join does NOT prevent path traversal. An absolute path
      as the second argument replaces the base entirely. Use
      os.path.realpath() and verify with startswith().
    metadata:
      cwe: CWE-22
      category: path-traversal
      confidence: LOW

  # --- subprocess.run with string command ---
  - id: broad-python-subprocess-string
    patterns:
      - pattern-either:
          - pattern: subprocess.run($CMD, shell=True, ...)
          - pattern: subprocess.call($CMD, shell=True, ...)
          - pattern: subprocess.Popen($CMD, shell=True, ...)
          - pattern: subprocess.check_output($CMD, shell=True, ...)
          - pattern: subprocess.check_call($CMD, shell=True, ...)
    languages: [python]
    severity: ERROR
    message: >
      subprocess with shell=True — high risk of command injection.
      Use subprocess.run(["cmd", "arg"], shell=False) instead.
    metadata:
      cwe: CWE-78
      category: command-injection
      confidence: HIGH

  # --- os.system / os.popen ---
  - id: broad-python-os-system
    patterns:
      - pattern-either:
          - pattern: os.system($X)
          - pattern: os.popen($X)
          - pattern: os.popen($X, ...)
    languages: [python]
    severity: ERROR
    message: >
      os.system/popen executes commands through the shell. Use
      subprocess.run with shell=False instead.
    metadata:
      cwe: CWE-78
      category: command-injection
      confidence: HIGH

  # --- subprocess with f-string command ---
  - id: broad-python-subprocess-fstring
    patterns:
      - pattern-either:
          - pattern: subprocess.run(f"...{$VAR}...", shell=True, ...)
          - pattern: subprocess.call(f"...{$VAR}...", shell=True, ...)
          - pattern: subprocess.Popen(f"...{$VAR}...", shell=True, ...)
          - pattern: os.system(f"...{$VAR}...")
          - pattern: os.popen(f"...{$VAR}...")
    languages: [python]
    severity: ERROR
    message: >
      Command built with f-string and executed through shell — definite
      command injection vulnerability.
    metadata:
      cwe: CWE-78
      category: command-injection
      confidence: HIGH

  # --- tempfile without secure usage ---
  - id: broad-python-tempfile-insecure
    patterns:
      - pattern-either:
          - pattern: tempfile.mktemp(...)
    languages: [python]
    severity: WARNING
    message: >
      tempfile.mktemp() is insecure (race condition). Use
      tempfile.mkstemp() or tempfile.NamedTemporaryFile() instead.
    metadata:
      cwe: CWE-377
      category: race-condition
      confidence: HIGH

  # --- assert used for validation (stripped in -O) ---
  - id: broad-python-assert-validation
    patterns:
      - pattern-either:
          - pattern: assert isinstance($X, ...)
          - pattern: assert $X is not None
          - pattern: assert len($X) ...
    languages: [python]
    severity: INFO
    message: >
      assert statements are removed with python -O. Do not use assert
      for input validation — use if/raise instead.
    metadata:
      cwe: CWE-617
      category: input-validation
      confidence: LOW

  # --- Logging sensitive data ---
  - id: broad-python-log-sensitive
    patterns:
      - pattern-either:
          - pattern: logging.$METHOD(..., $X.password, ...)
          - pattern: logging.$METHOD(..., $X.token, ...)
          - pattern: logging.$METHOD(..., $X.secret, ...)
          - pattern: logging.$METHOD(..., $X.api_key, ...)
          - pattern: print(..., $X.password, ...)
          - pattern: print(..., $X.token, ...)
    languages: [python]
    severity: WARNING
    message: >
      Logging potentially sensitive data (password, token, secret).
    metadata:
      cwe: CWE-532
      category: information-disclosure
      confidence: MEDIUM

  # --- Hardcoded temp/debug flags ---
  - id: broad-python-debug-enabled
    patterns:
      - pattern-either:
          - pattern: DEBUG = True
          - pattern: app.debug = True
          - pattern: app.config["DEBUG"] = True
    languages: [python]
    severity: WARNING
    message: >
      Debug mode enabled. Ensure this is not deployed to production.
    metadata:
      cwe: CWE-489
      category: configuration
      confidence: MEDIUM
